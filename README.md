# PCHED Node & RPC Proxy Architecture

This repository documents the custom infrastructure running on `rpc1.pchednode.com` (and related nodes). It aggregates Xandeum network data from multiple sources, logs historical metrics, and serves a rich web interface.

## üèó System Architecture

The system is divided into three distinct roles: **Collector**, **Historian**, and **Presenter**.

### 1. The Collector (RPC Proxy)
**Service:** `rpc-proxy.service`  
**Path:** `/opt/rpc-proxy/index.js`  
**Port:** `5999` (Internal)

* **Role:** Aggregates real-time "gossip" data.
* **Sources:**
    1.  **Local RPC:** Calls `127.0.0.1:6000` (The local Xandeum node).
    2.  **External RPC:** Calls `173.249.42.124:6000` (External redundancy).
* **Logic:**
    * Polls both sources every **60 seconds**.
    * Merges data based on **IP Address** (Unique Key).
    * Preserves "version" and "pubkey" if a source returns `unknown`.
* **Output:** Writes to `/opt/rpc-proxy/merged.json`.

### 2. The Historian (Data Logger)
**Service:** `history-logger.service`  
**Path:** `/opt/rpc-proxy/monitor_fast.py`

* **Role:** Captures snapshots of network health for historical graphing.
* **Interval:** Runs every **5 minutes**.
* **Inputs:**
    * Reads `/opt/rpc-proxy/merged.json` (for Storage/Uptime).
    * Fetches `podcredits` API (for Credits).
    * Reads `chain_data.json` (for Staking info).
    * Pings each IP (for Latency).
* **Output:** Appends CSV lines to `/opt/rpc-proxy/history/<IP>.csv`.

### 3. The Presenter (Geo & Web API)
**Service:** `geo-proxy.service`  
**Path:** `/opt/geo-proxy/geo.py`  
**Port:** `5998` (Internal)

* **Role:** The backend for the web frontend.
* **Features:**
    * **Geo-Location:** Maps IPs to Countries/ASNs using `ip2asn-v4-u32.tsv.gz`.
    * **Batch Processing:** `/geo/batch` enriches the main table with flags, names, and stake.
    * **History API:** `/geo/history?ip=x` serves raw CSV data to the frontend charts.
    * **On-Chain Data:** Reads `/opt/geo-proxy/chain_data.json` (generated by `nft-scanner.service`) to display NFTs and Stake.

---

## üìÇ File Structure & Key Paths

| Path | Description |
| :--- | :--- |
| **`/opt/rpc-proxy/`** | **Primary Directory** |
| `index.js` | Main Node.js proxy script (Collector). |
| `merged.json` | **The "Database".** The current state of all known pods. |
| `monitor_fast.py` | Python script that writes history CSVs. |
| `history/` | Directory containing thousands of `<IP>.csv` files. |
| **`/opt/geo-proxy/`** | **Secondary Directory (Python Helpers)** |
| `geo.py` | Flask API for GeoIP, names, and serving history. |
| `monitor_chain.py` | Slow scanner (runs every 2h) for NFTs and Stake on Solana. |
| `chain_data.json` | Cache file containing Staking/NFT data per Pubkey. |
| `servery.csv` | Manual mapping of IP Addresses to "Friendly Names". |

---

## üåê Web Interface (Frontend)
**Location:** `/var/www/html/` (Served via Nginx)

* **`index.html` + `script.js`**: The main dashboard.
    * Connects to `/rpc` (Nginx proxies to Port 5999) for the list of pods.
    * Connects to `/geo/batch` (Nginx proxies to Port 5998) to enrich rows with flags/names.
* **`history.html`**: The detail view for a specific node.
    * Uses **Chart.js** to render graphs from the CSV data.
* **`pchedai.html`**: AI Chat Interface.

---

## üîÑ Data Flow Diagram

```mermaid
graph TD
    User[User / Browser]
    
    subgraph "Nginx (Port 443)"
        EndpointRPC["/rpc"]
        EndpointGeo["/geo"]
    end

    subgraph "The Collector (Node.js)"
        IndexJS["index.js (Port 5999)"]
        MergedJSON[("merged.json")]
    end

    subgraph "The Historian (Python)"
        MonitorFast["monitor_fast.py"]
        CSVFiles[("/history/*.csv")]
    end
    
    subgraph "The Presenter (Python)"
        GeoPy["geo.py (Port 5998)"]
        ChainMonitor["monitor_chain.py"]
        ChainJSON[("chain_data.json")]
    end

    User --> EndpointRPC
    User --> EndpointGeo
    
    EndpointRPC --> IndexJS
    EndpointGeo --> GeoPy

    IndexJS -- Writes --> MergedJSON
    
    MonitorFast -- Reads --> MergedJSON
    MonitorFast -- Writes --> CSVFiles
    
    GeoPy -- Reads --> CSVFiles
    GeoPy -- Reads --> ChainJSON
    
    ChainMonitor -- Writes --> ChainJSON
    ChainMonitor -- Reads --> MergedJSON
