<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pod History</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    
    <link rel="stylesheet" href="style.css">
    <style>
        .ascii-graph {
            white-space: pre;
            line-height: 1.1;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            overflow-x: hidden;
        }
        .stat-card {
            transition: all 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .copy-feedback {
            animation: fadeOut 1.5s forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-lime-100 to-green-200 dark:from-slate-900 dark:to-gray-900 transition-colors duration-500 text-gray-900 dark:text-gray-100">
    <div class="max-w-7xl mx-auto p-4 md:p-8">
        
        <header class="mb-8 flex flex-col xl:flex-row items-start xl:items-center justify-between border-b border-gray-300/50 dark:border-gray-700/50 pb-6 gap-6">
            <div class="flex flex-col md:flex-row items-start md:items-center gap-4 w-full xl:w-auto">
                <a href="/" class="px-4 py-2 bg-white/50 dark:bg-gray-800/50 hover:bg-white/80 dark:hover:bg-gray-700/80 rounded-lg font-semibold transition shadow-sm backdrop-blur shrink-0">
                    ← Back
                </a>
                
                <div class="flex flex-col">
                    <h1 class="text-2xl md:text-3xl font-extrabold flex items-center gap-3">
                        <span id="display-name" class="text-gray-900 dark:text-white">Loading...</span>
                    </h1>
                    
                    <div class="flex flex-col md:flex-row md:items-center gap-x-6 gap-y-1 mt-1 text-sm md:text-base">
                        <div class="font-mono text-indigo-700 dark:text-indigo-400 font-bold" id="display-ip">...</div>
                        
                        <div class="flex items-center gap-2 group cursor-pointer" onclick="copyHeaderPubkey()" title="Click to copy Pubkey">
                            <span class="font-mono text-gray-500 dark:text-gray-400">Pub:</span>
                            <span id="display-pubkey" class="font-mono text-gray-600 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">...</span>
                            <span id="copy-msg" class="text-xs font-bold text-green-600 opacity-0 transition-opacity">Copied!</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex bg-white/40 dark:bg-gray-800/40 rounded-lg p-1 backdrop-blur shadow-sm self-start xl:self-center">
                <button onclick="setTimeframe(24)" id="btn-24h" class="px-3 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-md">24H</button>
                <button onclick="setTimeframe(168)" id="btn-7d" class="px-3 py-1.5 rounded-md text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-gray-700/50">7D</button>
                <button onclick="setTimeframe(720)" id="btn-30d" class="px-3 py-1.5 rounded-md text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-gray-700/50">30D</button>
                <button onclick="setTimeframe(0)" id="btn-all" class="px-3 py-1.5 rounded-md text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-gray-700/50">ALL</button>
            </div>
        </header>

        <main id="main-content" class="space-y-6">
            <div id="loading" class="text-center py-20 text-gray-500 dark:text-gray-400 animate-pulse">
                Fetching history data...
            </div>

            <div id="error-msg" class="hidden p-6 bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-xl text-center text-red-600 dark:text-red-400">
                Data not available for this IP.
            </div>

            <div id="dashboard" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="stat-card bg-white/80 dark:bg-gray-800/90 backdrop-blur rounded-xl shadow-xl p-5 border-t-4 border-indigo-500">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-2">Network Latency (Ping)</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-3xl font-mono font-bold text-gray-800 dark:text-white" id="val-ping">0</span>
                        <span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400 mb-1">ms</span>
                    </div>
                    <div class="ascii-graph text-indigo-600 dark:text-indigo-400 text-xs tracking-tighter h-12 flex items-end overflow-hidden" id="graph-ping"></div>
                </div>

                <div class="stat-card bg-white/80 dark:bg-gray-800/90 backdrop-blur rounded-xl shadow-xl p-5 border-t-4 border-purple-500">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-2">Pod Credits</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-3xl font-mono font-bold text-gray-800 dark:text-white" id="val-credits">0</span>
                        <span class="text-xs font-semibold text-purple-600 dark:text-purple-400 mb-1">Total</span>
                    </div>
                    <div class="ascii-graph text-purple-600 dark:text-purple-400 text-xs tracking-tighter h-12 flex items-end overflow-hidden" id="graph-credits"></div>
                </div>

                <div class="stat-card bg-white/80 dark:bg-gray-800/90 backdrop-blur rounded-xl shadow-xl p-5 border-t-4 border-blue-500">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-2">SOL Balance</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-3xl font-mono font-bold text-gray-800 dark:text-white" id="val-balance">0</span>
                        <span class="text-xs font-semibold text-blue-600 dark:text-blue-400 mb-1">SOL</span>
                    </div>
                    <div class="ascii-graph text-blue-600 dark:text-blue-400 text-xs tracking-tighter h-12 flex items-end overflow-hidden" id="graph-balance"></div>
                </div>

                <div class="stat-card bg-white/80 dark:bg-gray-800/90 backdrop-blur rounded-xl shadow-xl p-5 border-t-4 border-emerald-500">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-2">Process Uptime</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-2xl font-mono font-bold text-gray-800 dark:text-white" id="val-uptime">-</span>
                        <span class="text-xs font-semibold text-emerald-600 dark:text-emerald-400 mb-1">Time</span>
                    </div>
                    <div class="ascii-graph text-emerald-600 dark:text-emerald-400 text-xs tracking-tighter h-12 flex items-end overflow-hidden" id="graph-uptime"></div>
                </div>

                <div class="stat-card bg-white/80 dark:bg-gray-800/90 backdrop-blur rounded-xl shadow-xl p-5 border-t-4 border-orange-500">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-2">Storage Committed</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-3xl font-mono font-bold text-gray-800 dark:text-white" id="val-storage">0</span>
                        <span class="text-xs font-semibold text-orange-600 dark:text-orange-400 mb-1">Size</span>
                    </div>
                    <div class="ascii-graph text-orange-600 dark:text-orange-400 text-xs tracking-tighter h-12 flex items-end overflow-hidden" id="graph-storage"></div>
                </div>

                <div class="stat-card bg-white/80 dark:bg-gray-800/90 backdrop-blur rounded-xl shadow-xl p-5 border-t-4 border-rose-500">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-2">Disk Usage</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-3xl font-mono font-bold text-gray-800 dark:text-white" id="val-usage">0%</span>
                        <span class="text-xs font-semibold text-rose-600 dark:text-rose-400 mb-1">Filled</span>
                    </div>
                    <div class="ascii-graph text-rose-600 dark:text-rose-400 text-xs tracking-tighter h-12 flex items-end overflow-hidden" id="graph-usage"></div>
                </div>

            </div>
        </main>

        <footer class="mt-12 text-center text-sm text-gray-600 dark:text-gray-400 pt-6 border-t border-gray-300/50 dark:border-gray-700/50">
            History data sourced via local CSV logs.
        </footer>
    </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const TARGET_IP = urlParams.get('ip');
    const TARGET_HOST = urlParams.get('host') || 'rpc1.pchednode.com';
    const GEO_HISTORY_URL = `https://${TARGET_HOST}/geo/history`;
    const GRAPH_SAMPLES = 60; 

    // Dark Mode
    const htmlEl = document.documentElement;
    if (localStorage.getItem('theme') === 'dark' || 
       (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        htmlEl.classList.add('dark');
    }

    let fullData = []; 
    let currentTimeframe = 24; 
    let fullPubkey = "";

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const rows = [];
        lines.forEach(line => {
            if (!line) return;
            const parts = line.split(',');
            if (parts.length >= 7 && !isNaN(parts[0])) {
                rows.push({
                    ts: parseInt(parts[0]),
                    ping: parseFloat(parts[1]) || 0,
                    credits: parseInt(parts[2]) || 0,
                    balance: parseFloat(parts[3]) || 0,
                    storage: parseFloat(parts[4]) || 0,
                    uptime: parseInt(parts[5]) || 0,
                    usage: parseFloat(parts[6]) || 0
                });
            }
        });
        return rows.sort((a,b) => a.ts - b.ts);
    }

    // UPDATED: Added forceZeroStart parameter
    function renderAsciiGraph(values, forceZeroStart = false) {
        if (!values || values.length === 0) return "No Data";
        
        // FIXED: Using \u2581 (Lower 1/8 Block) instead of Space for the lowest level
        // to ensure low values (like recent restarts) are visible.
        const blocks = ["\u2581", "▂", "▃", "▄", "▅", "▆", "▇", "█"];
        
        let min = Math.min(...values);
        const max = Math.max(...values);
        
        // FORCE FIX: If this is uptime (or forceZeroStart is true), anchor min to 0
        if (forceZeroStart) min = 0;

        let range = max - min;
        if (range === 0) range = 1; 
        
        return values.map(val => {
            const normalized = (val - min) / range;
            // Clamp value between 0 and 1 just in case
            const clamped = Math.max(0, Math.min(1, normalized));
            const index = Math.floor(clamped * (blocks.length - 1));
            return blocks[index];
        }).join("");
    }

    function processDataForGraph(data, key) {
        const now = Math.floor(Date.now() / 1000);
        const cutoff = currentTimeframe === 0 ? 0 : now - (currentTimeframe * 3600);
        const filtered = data.filter(row => row.ts >= cutoff);
        if (filtered.length === 0) return [];

        const result = [];
        const step = Math.max(1, Math.floor(filtered.length / GRAPH_SAMPLES));
        
        for (let i = 0; i < filtered.length; i += step) {
            const chunk = filtered.slice(i, i + step);
            
            let val;
            if (key === 'uptime') {
                // Keep the Minimum Logic for Uptime
                val = Math.min(...chunk.map(r => r[key]));
            } else {
                const sum = chunk.reduce((acc, row) => acc + row[key], 0);
                val = sum / chunk.length;
            }
            
            result.push(val);
        }
        return result;
    }

    function formatStorage(bytes) {
        const gb = bytes / (1024 * 1024 * 1024);
        if (gb >= 1000) return `${(gb / 1024).toFixed(1)} TB`;
        return `${gb.toFixed(1)} GB`;
    }
    
    function formatUptime(seconds) {
        if (seconds < 3600) return `${Math.floor(seconds/60)}m`;
        if (seconds < 86400) return `${Math.floor(seconds/3600)}h`;
        return `${Math.floor(seconds/86400)}d`;
    }

    function formatPercent(val) {
        const pct = val * 100;
        if (pct < 0.01 && pct > 0) return "< 0.01%";
        return `${pct.toFixed(2)}%`;
    }

    function updateDashboard() {
        if (!fullData || fullData.length === 0) return;
        const latest = fullData[fullData.length - 1];

        document.getElementById('val-ping').innerText = latest.ping.toFixed(1);
        document.getElementById('val-credits').innerText = new Intl.NumberFormat().format(latest.credits);
        document.getElementById('val-balance').innerText = latest.balance.toFixed(3);
        document.getElementById('val-storage').innerText = formatStorage(latest.storage);
        document.getElementById('val-uptime').innerText = formatUptime(latest.uptime);
        document.getElementById('val-usage').innerText = formatPercent(latest.usage);

        document.getElementById('graph-ping').innerText = renderAsciiGraph(processDataForGraph(fullData, 'ping'));
        document.getElementById('graph-credits').innerText = renderAsciiGraph(processDataForGraph(fullData, 'credits'));
        document.getElementById('graph-balance').innerText = renderAsciiGraph(processDataForGraph(fullData, 'balance'));
        document.getElementById('graph-storage').innerText = renderAsciiGraph(processDataForGraph(fullData, 'storage'));
        
        // PASS TRUE to force Uptime to scale from 0
        document.getElementById('graph-uptime').innerText = renderAsciiGraph(processDataForGraph(fullData, 'uptime'), true);
        
        document.getElementById('graph-usage').innerText = renderAsciiGraph(processDataForGraph(fullData, 'usage'));
    }

    function setTimeframe(hours) {
        currentTimeframe = hours;
        ['24h', '7d', '30d', 'all'].forEach(id => {
            const btn = document.getElementById(`btn-${id}`);
            if ((hours === 24 && id === '24h') || 
                (hours === 168 && id === '7d') || 
                (hours === 720 && id === '30d') || 
                (hours === 0 && id === 'all')) {
                btn.className = "px-3 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-md";
            } else {
                btn.className = "px-3 py-1.5 rounded-md text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-gray-700/50";
            }
        });
        updateDashboard();
    }

    // --- NEW: Copy Function ---
    function copyHeaderPubkey() {
        if (!fullPubkey || fullPubkey === "N/A" || fullPubkey === "Unknown") return;
        navigator.clipboard.writeText(fullPubkey).then(() => {
            const el = document.getElementById('copy-msg');
            el.classList.remove('opacity-0', 'copy-feedback');
            // Trigger reflow
            void el.offsetWidth;
            el.classList.add('copy-feedback');
        });
    }

    // --- INITIALIZATION ---
    if (!TARGET_IP) {
        document.getElementById('loading').innerText = "No IP specified.";
    } else {
        document.getElementById('display-ip').innerText = TARGET_IP;
        
        fetch(`${GEO_HISTORY_URL}?ip=${TARGET_IP}`)
            .then(res => {
                if (!res.ok) throw new Error("Not Found");
                return res.json(); 
            })
            .then(data => {
                // 1. Handle Metadata
                const meta = data.meta || {};
                document.getElementById('display-name').innerText = meta.name || "N/A";
                
                fullPubkey = meta.pubkey || "N/A";
                if (fullPubkey && fullPubkey.length > 10) {
                    document.getElementById('display-pubkey').innerText = fullPubkey.slice(0, 6) + "..." + fullPubkey.slice(-6);
                } else {
                    document.getElementById('display-pubkey').innerText = fullPubkey;
                }

                // 2. Handle CSV Data
                const csvText = data.csv_data;
                fullData = parseCSV(csvText);
                
                if (fullData.length === 0) {
                    throw new Error("Empty Data");
                }
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                updateDashboard();
            })
            .catch(err => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error-msg').classList.remove('hidden');
                console.error(err);
            });
    }
</script>
</body>
</html>
