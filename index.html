<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pchednode RPC Viewer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for appearance */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        #output table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px; /* Space between rows */
        }
        #output thead th {
            text-align: left;
            padding: 8px 16px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280; /* Gray-500 */
        }
        #output tbody tr {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        #output tbody tr:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        #output tbody td {
            padding: 12px 16px;
            border: none;
            font-size: 0.9rem;
            color: #1f2937; /* Gray-800 */
        }
        .fresh { color: #10b981; font-weight: 600; } /* Green-500 */
        .recent { color: #f59e0b; } /* Amber-500 */
        .stale { color: #ef4444; } /* Red-500 */
        
        /* Highlighting known server rows */
        .known-server {
            background-color: #eef2ff !important; /* Indigo-50 */
            border-left: 4px solid #4f46e5; /* Indigo-600 */
        }
        .known-server td {
            font-weight: 600;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6 flex items-center justify-between border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900">
                pchednode RPC Viewer for Xandeum Network
            </h1>
            <img src="pched.jpg" alt="Logo" id="logo" class="w-12 h-12 rounded-lg shadow-md">
        </header>

        <!-- Controls -->
        <main class="space-y-6">
            <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-4 md:space-y-0 md:space-x-4 p-4 bg-white rounded-lg shadow-md">
                <div class="flex items-center space-x-2">
                    <label for="rpcSelector" class="font-medium text-gray-700 whitespace-nowrap">RPC Server:</label>
                    <select id="rpcSelector" class="form-select border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="https://rpc1.pchednode.com/rpc">DevNet 1</option>
                        <option value="https://rpc2.pchednode.com/rpc">DevNet 2</option>
                        <option value="https://rpc3.pchednode.com/rpc">DevNet 3</option>
                        <option value="https://rpc4.pchednode.com/rpc">DevNet 4</option>
                    </select>
                </div>
            
                <button id="loadButton" onclick="sendRpcRequest()" 
                        class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    LOAD
                </button>
            
                <div id="filterBar" class="flex items-center space-x-4 text-sm md:text-base ml-auto">
                    <div class="font-bold text-gray-700">Pods: <span id="podCount" class="text-indigo-600">0</span></div>
                    <label class="flex items-center space-x-1 cursor-pointer">
                        <input type="checkbox" id="versionFilterToggle" class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                        <span class="text-gray-700 whitespace-nowrap">Filter by version</span>
                    </label>
                    <input type="text" id="versionFilterValue" value="0.4.2" placeholder="e.g. 0.4.2" 
                           class="w-24 border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            </div>

            <div id="output" class="p-4 bg-white rounded-lg shadow-xl text-center">
                <p class="text-gray-500">Click LOAD to fetch pod data...</p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-8 text-center text-sm text-gray-500 border-t pt-4">
            &copy; 2025 Substance242 | Data sourced via pchednode RPCs and custom Geo API.
        </footer>
    </div>

    <!-- JavaScript Logic -->
    <script>
        let hasLoadedOnce = false;

        function formatRelativeTime(timestamp) {
            const now = Math.floor(Date.now() / 1000);
            const diff = now - timestamp;

            if (diff < 60) return { text: `${diff} seconds ago`, class: "fresh" };
            if (diff < 3600) return { text: `${Math.floor(diff / 60)} minutes ago`, class: "recent" };
            return { text: `${Math.floor(diff / 3600)} hours ago`, class: "stale" };
        }

        function markLoadButton() {
            const btn = document.getElementById("loadButton");
            btn.classList.add("bg-yellow-500", "shadow-yellow-400/70");
            btn.classList.remove("bg-indigo-600");
            btn.textContent = "RELOAD";
        }

        function clearLoadButtonHighlight() {
            const btn = document.getElementById("loadButton");
            btn.classList.remove("bg-yellow-500", "shadow-yellow-400/70");
            btn.classList.add("bg-indigo-600");
        }

        async function sendRpcRequest() {
            const btn = document.getElementById("loadButton");
            if (!hasLoadedOnce) {
                btn.textContent = "RELOAD";
                hasLoadedOnce = true;
            }
            clearLoadButtonHighlight();

            const rpcUrl = document.getElementById("rpcSelector").value;
            const rpcHost = new URL(rpcUrl).hostname;
            const geoBase = `https://${rpcHost}/geo`;

            const output = document.getElementById("output");
            output.innerHTML = '<p class="text-center text-indigo-600 font-semibold">Loading pod list...</p>';

            let response;
            try {
                response = await fetch(rpcUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ jsonrpc: "2.0", method: "get-pods", id: 1 })
                });
            } catch (e) {
                output.innerHTML = `<p class="text-red-500">Network Error: Could not reach ${rpcUrl}.</p>`;
                return;
            }

            if (!response.ok) {
                output.innerHTML = `<p class="text-red-500">Error: RPC returned status ${response.status} (${response.statusText}).</p>`;
                return;
            }

            const data = await response.json();
            const pods = data.result?.pods || [];
            const podCount = document.getElementById("podCount");
            const filterToggle = document.getElementById("versionFilterToggle");
            const filterValue = document.getElementById("versionFilterValue").value.trim();

            let filteredPods = pods;
            if (filterToggle.checked && filterValue !== "") {
                filteredPods = pods.filter(pod => pod.version === filterValue);
            }

            filteredPods.sort((a, b) => b.last_seen_timestamp - a.last_seen_timestamp);
            podCount.textContent = filteredPods.length;

            if (filteredPods.length === 0) {
                output.innerHTML = "<p class='text-gray-500'>No pods found matching the filter criteria.</p>";
                return;
            }

            // Cache to store IP info (Country, Name) to avoid duplicate lookups
            const ipCache = {};
            let tableHTML = `
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <!-- NEW COLUMN HEADER ADDED HERE -->
                            <th class="rounded-tl-lg">Name</th> 
                            <th>IP Address</th>
                            <th>Country</th>
                            <th>Last Seen</th>
                            <th class="rounded-tr-lg">Version</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const pod of filteredPods) {
                const ip = pod.address.split(":")[0];
                const lastSeen = formatRelativeTime(pod.last_seen_timestamp);
                
                // Initialize country and name placeholders
                const countryDisplay = ipCache[ip]?.country || "Loading...";
                const nameDisplay = ipCache[ip]?.name || "N/A";

                tableHTML += `
                    <tr class="mb-2">
                        <!-- NEW COLUMN DATA CELL -->
                        <td id="name-${ip}" class="${nameDisplay !== 'N/A' ? 'font-semibold text-indigo-700' : 'text-gray-500'}">${nameDisplay}</td>
                        <td>${ip}</td>
                        <td id="country-${ip}">${countryDisplay}</td>
                        <td class="${lastSeen.class}">${lastSeen.text}</td>
                        <td>${pod.version}</td>
                    </tr>
                `;

                // If IP not in cache, fetch Geo data
                if (!ipCache[ip]) {
                    ipCache[ip] = { country: "Loading...", name: "N/A" }; // Mark as loading
                    
                    // Asynchronously fetch geo info
                    fetch(`${geoBase}?ip=${ip}`)
                        .then(res => res.json())
                        .then(geoData => {
                            const code = geoData.country_code?.toLowerCase() || "";
                            const countryName = geoData.country || "Unknown";
                            const serverName = geoData.name; // The custom name from geo.py
                            
                            // 1. Update Name Cell
                            const nameCell = document.getElementById(`name-${ip}`);
                            if (nameCell) {
                                nameCell.textContent = serverName || "N/A";
                                nameCell.classList.remove('text-gray-500');
                                nameCell.classList.add('font-semibold');
                                
                                // Highlight the entire row if a custom name is found
                                if (serverName) {
                                    nameCell.parentElement.classList.add('known-server');
                                    nameCell.classList.add('text-indigo-700');
                                } else {
                                     nameCell.classList.add('text-gray-500');
                                }
                                ipCache[ip].name = serverName || "N/A";
                            }
                            
                            // 2. Update Country/Flag Cell
                            const flag = code ? `<img src="https://flagcdn.com/16x12/${code}.png" alt="${code}" class="inline-block mr-2">` : "";
                            const countryDisplayHtml = `${flag}${countryName}`;
                            
                            ipCache[ip].country = countryDisplayHtml;
                            
                            const countryCell = document.getElementById(`country-${ip}`);
                            if (countryCell) countryCell.innerHTML = countryDisplayHtml;

                        })
                        .catch(error => {
                            console.error(`Error fetching geo data for ${ip}:`, error);
                            // Update Name and Country cells to show error
                            const nameCell = document.getElementById(`name-${ip}`);
                            if (nameCell) nameCell.textContent = "Geo Error";
                            const countryCell = document.getElementById(`country-${ip}`);
                            if (countryCell) countryCell.textContent = "Geo Error";
                            ipCache[ip].country = "Geo Error";
                            ipCache[ip].name = "N/A";
                        });
                }
            }

            tableHTML += "</tbody></table>";
            output.innerHTML = tableHTML;
        }

        // Event Listeners
        window.addEventListener("load", markLoadButton);
        document.getElementById("rpcSelector").addEventListener("change", markLoadButton);
        document.getElementById("versionFilterToggle").addEventListener("change", markLoadButton);
        document.getElementById("versionFilterValue").addEventListener("input", markLoadButton);
        
        // Initial load on startup
        window.addEventListener("load", sendRpcRequest); 
    </script>
</body>
</html>
