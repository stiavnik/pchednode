<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>pchednode</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom right, #fefee0, #e0f7ff);
      margin: 0;
      padding: 0;
    }

    header {
      position: relative;
      background-color: #ffffffcc;
      padding: 20px;
      text-align: left;
      font-size: 1.8em;
      font-weight: bold;
      color: #333;
    }

    #logo {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 160px;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    main {
      padding: 20px;
    }

    label, select, button, input {
      font-size: 1em;
      margin: 10px 5px 10px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #ffffe0;
      color: #333;
    }

    select:hover, button:hover, input:hover {
      background-color: #e0f7ff;
    }

    #filterBar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 0;
    }

    #output {
      margin-top: 10px;
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
    }

    table {
      width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
      font-size: 0.95em;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      background-color: #e0f7ff;
      padding: 6px;
    }

    td {
      background-color: #fffff8;
      padding: 6px;
    }

    .fresh { color: green; font-weight: bold; }
    .recent { color: orange; font-weight: bold; }
    .stale { color: red; font-weight: bold; }
  </style>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
  <header>
    pchednode RPC viewer for Xandeum Network
    <img src="pched.jpg" alt="Logo" id="logo">
  </header>

  <main>
    <label for="rpcSelector">Choose RPC Server:</label>
    <select id="rpcSelector">
      <option value="https://rpc1.pchednode.com/rpc">DevNet 1</option>
      <option value="https://rpc2.pchednode.com/rpc">DevNet 2</option>
      <option value="https://rpc3.pchednode.com/rpc">DevNet 3</option>
      <option value="https://rpc4.pchednode.com/rpc">DevNet 4</option>
    </select>

    <button onclick="sendRpcRequest()">Send RPC Request</button>

    <div id="filterBar">
      <div style="font-weight: bold;">Pods: <span id="podCount">0</span></div>
      <label><input type="checkbox" id="versionFilterToggle"> Filter by version</label>
      <input type="text" id="versionFilterValue" value="0.4.2" placeholder="e.g. 0.4.2">
    </div>

    <div id="output">Waiting for response...</div>
  </main>

	<script>
	  function formatRelativeTime(timestamp) {
		  const now = Math.floor(Date.now() / 1000);
		  const diff = now - timestamp;

		  if (diff < 60)
			  return {
				  text: `${diff} seconds ago`,
				  class: "fresh"
			  };
		  if (diff < 3600)
			  return {
				  text: `${Math.floor(diff / 60)} minutes ago`,
				  class: "recent"
			  };
		  return {
			  text: `${Math.floor(diff / 3600)} hours ago`,
			  class: "stale"
		  };
	  }

	  async function sendRpcRequest() {
		  const rpcUrl = document.getElementById("rpcSelector").value;
		  const rpcHost = new URL(rpcUrl).hostname;
		  const geoBase = `https://${rpcHost}/geo`;

		  const response = await fetch(rpcUrl, {
			  method: "POST",
			  headers: {
				  "Content-Type": "application/json"
			  },
			  body: JSON.stringify({
				  jsonrpc: "2.0",
				  method: "get-pods",
				  id: 1
			  })
		  });

		  if (!response.ok) {
			  document.getElementById("output").innerHTML = "Error: " + response.statusText;
			  return;
		  }

		  const data = await response.json();
		  const pods = data.result?.pods || [];
		  const output = document.getElementById("output");
		  const podCount = document.getElementById("podCount");
		  const filterToggle = document.getElementById("versionFilterToggle");
		  const filterValue = document.getElementById("versionFilterValue").value.trim();

		  let filteredPods = pods;
		  if (filterToggle.checked && filterValue !== "") {
			  filteredPods = pods.filter(pod => pod.version === filterValue);
		  }

		  filteredPods.sort((a, b) => b.last_seen_timestamp - a.last_seen_timestamp);
		  podCount.textContent = filteredPods.length;

		  if (filteredPods.length === 0) {
			  output.innerHTML = "<p>No pods found.</p>";
			  return;
		  }

		  const ipCache = {};
		  let tableHTML = `
		  <table>
			<thead>
			  <tr>
				<th>IP Address</th>
				<th>Country</th>
				<th>Last Seen</th>
				<th>Version</th>
			  </tr>
			</thead>
			<tbody>
		`;

		  for (const pod of filteredPods) {
			  const ip = pod.address.split(":")[0];
			  const lastSeen = formatRelativeTime(pod.last_seen_timestamp);
			  const country = ipCache[ip] || "Loading...";

			  tableHTML += `
			<tr>
			  <td>${ip}</td>
			  <td id="country-${ip}">${country}</td>
			  <td class="${lastSeen.class}">${lastSeen.text}</td>
			  <td>${pod.version}</td>
			</tr>
		  `;

			  if (!ipCache[ip]) {
				fetch(`${geoBase}?ip=${ip}`)
				  .then(res => res.json())
				  .then(data => {
					console.log("Geo response for", ip, data); // <-- Add this
					const country = data.country || data.country_long || "Unknown";
					ipCache[ip] = country;
					const cell = document.getElementById(`country-${ip}`);
					if (cell) cell.textContent = country;
				  })
				  .catch(err => {
					console.error("Geo fetch error for", ip, err);
					ipCache[ip] = "Error";
					const cell = document.getElementById(`country-${ip}`);
					if (cell) cell.textContent = "Error";
				  });
			  }
		  }

		  tableHTML += "</tbody></table>";
		  output.innerHTML = tableHTML;
	  }
	</script>

</body>
</html>
